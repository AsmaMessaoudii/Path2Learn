{% extends 'base.html.twig' %}

{% block title %}Vérification 2FA{% endblock %}

{% block body %}
<section class="py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-5">
                <div class="card shadow">
                    <!-- Card header -->
                    <div class="card-header bg-success bg-opacity-10">
                        <h4 class="text-success mb-0">
                            <i class="bi bi-shield-check me-2"></i>Vérification en deux étapes
                        </h4>
                        <p class="mb-0 small">Sécurité renforcée</p>
                    </div>

                    <!-- Card body -->
                    <div class="card-body p-4">

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Un code à 6 chiffres a été envoyé à votre adresse email.
                        </div>

                        <!-- Status -->
                        <div id="status"></div>

                        <!-- Code Input -->
                        <div class="mb-4">
                            <label for="code2fa" class="form-label fw-bold">
                                <i class="bi bi-key me-1 text-success"></i>Entrez le code de vérification
                            </label>
                            <input type="text" 
                                   id="code2fa" 
                                   class="form-control form-control-lg text-center" 
                                   placeholder="000000"
                                   maxlength="6"
                                   pattern="[0-9]{6}"
                                   autocomplete="off"
                                   style="letter-spacing: 10px; font-size: 24px;"
                                   autofocus>
                            <small class="text-muted">Entrez les 6 chiffres reçus par email</small>
                        </div>

                        <!-- Timer -->
                        <div class="alert alert-warning text-center" id="timer">
                            <i class="bi bi-clock me-2"></i>
                            Code valide pendant: <strong id="timeLeft">5:00</strong>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button id="verifyBtn" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle me-2"></i>Vérifier le code
                            </button>

                            <button id="resendBtn" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-repeat me-2"></i>Renvoyer le code
                            </button>

                            <a href="{{ path('app_face_login') }}" class="btn btn-outline-danger">
                                <i class="bi bi-x-circle me-2"></i>Annuler
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
const code2faInput = document.getElementById('code2fa');
const verifyBtn = document.getElementById('verifyBtn');
const resendBtn = document.getElementById('resendBtn');
const status = document.getElementById('status');
const timeLeftSpan = document.getElementById('timeLeft');

let timeLeft = 300; // 5 minutes en secondes

// Timer countdown
const timerInterval = setInterval(() => {
    timeLeft--;
    
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timeLeftSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
        clearInterval(timerInterval);
        status.className = 'alert alert-danger';
        status.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Code expiré. Veuillez recommencer.';
        verifyBtn.disabled = true;
        code2faInput.disabled = true;
    } else if (timeLeft <= 60) {
        document.getElementById('timer').className = 'alert alert-danger text-center';
    }
}, 1000);

// Auto-submit when 6 digits entered
code2faInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
    if (e.target.value.length === 6) {
        verifyCode();
    }
});

// Verify code
verifyBtn.addEventListener('click', verifyCode);

async function verifyCode() {
    const code = code2faInput.value.trim();
    
    if (code.length !== 6) {
        status.className = 'alert alert-warning';
        status.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Veuillez entrer un code à 6 chiffres.';
        return;
    }
    
    verifyBtn.disabled = true;
    status.className = 'alert alert-info';
    status.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Vérification en cours...';
    
    try {
        const response = await fetch('{{ path('api_face_verify_2fa') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ code: code })
        });
        
        const result = await response.json();
        
        if (result.success) {
            clearInterval(timerInterval);
            status.className = 'alert alert-success';
            status.innerHTML = '<i class="bi bi-check-circle me-2"></i>✅ Code valide! Connexion en cours...';
            
            setTimeout(() => {
                window.location.href = result.redirect || '{{ path('home') }}';
            }, 1500);
        } else {
            status.className = 'alert alert-danger';
            status.innerHTML = '<i class="bi bi-x-circle me-2"></i>❌ ' + result.error;
            verifyBtn.disabled = false;
            code2faInput.value = '';
            code2faInput.focus();
        }
    } catch (error) {
        status.className = 'alert alert-danger';
        status.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>❌ Erreur: ' + error.message;
        verifyBtn.disabled = false;
    }
}

// Resend code
resendBtn.addEventListener('click', async () => {
    resendBtn.disabled = true;
    status.className = 'alert alert-info';
    status.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Envoi en cours...';
    
    try {
        const response = await fetch('{{ path('api_face_resend_2fa') }}', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            status.className = 'alert alert-success';
            status.innerHTML = '<i class="bi bi-check-circle me-2"></i>✅ ' + result.message;
            
            // Reset timer
            timeLeft = 300;
            
            setTimeout(() => {
                resendBtn.disabled = false;
            }, 30000); // 30 secondes avant de pouvoir renvoyer
        } else {
            status.className = 'alert alert-danger';
            status.innerHTML = '<i class="bi bi-x-circle me-2"></i>❌ ' + result.error;
            resendBtn.disabled = false;
        }
    } catch (error) {
        status.className = 'alert alert-danger';
        status.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>❌ Erreur: ' + error.message;
        resendBtn.disabled = false;
    }
});
</script>
{% endblock %}